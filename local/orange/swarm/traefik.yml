version: "3.4"

networks:

  default:
    external:
      name: orange_default

services:

  traefik:
    hostname: traefik
    build: traefik/
    image: sofwerx/traefik
    restart: "on-failure"
    ports:
      - 443:443
      - 80:80
    environment:
      HTTP_PORT: "80"
      HTTPS_PORT: "443"
      REST_PORT: "8080"
      EMAIL: "devops@sofwerx.org"
      DNS_DOMAIN: ${DNS_DOMAIN}
      SUBDOMAINS: ${SUBDOMAINS}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION}
      DOCKER_SWARMMODE: "true"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --docker --docker.swarmmode --docker.domain=${DNS_DOMAIN} --docker.watch --web
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - "node.role == manager"
          - "engine.labels.storage-constrained != true"
      labels:
        - "traefik.enabled=true"
        - "traefik.backend=traefik"
        - "traefik.backend.loadbalancer.swarm=true"
        - "traefik.port=8080"
        - "traefik.frontend.rule=Host:traefik.${DNS_DOMAIN}"
        - "traefik.frontend.passHostHeader=true"
        - "traefik.frontend.entryPoints=http,https"


